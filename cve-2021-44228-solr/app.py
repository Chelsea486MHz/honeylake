import re
import os
import json
from pathlib import Path
from flask import Flask, request, jsonify, render_template

from honeylake_common import setup_logging, save_exploit_sample, get_env_int, get_env_str, get_real_client_ip

logger = setup_logging(__name__)

app = Flask(__name__)

SAMPLES_DIR = Path('/samples')

LISTEN_HOST = get_env_str('LISTEN_HOST', '0.0.0.0')
LISTEN_PORT = get_env_int('LISTEN_PORT', 8000)
SOLR_VERSION = get_env_str('SOLR_VERSION', '8.11.0')
APACHE_VERSION = get_env_str('APACHE_VERSION', '2.4.41')
COLLECTION_NAME = get_env_str('COLLECTION_NAME', 'collection1')

# from https://github.com/back2root/log4shell-rex
JNDI_PATTERN = re.compile(r'(?im)(?:^|[\n]).*?(?:[\x24]|%(?:25%?)*24|\\u?0*(?:44|24))(?:[\x7b]|%(?:25%?)*7b|\\u?0*(?:7b|173))[^\n]*?((?:j|%(?:25%?)*(?:4a|6a)|\\u?0*(?:112|6a|4a|152))[^\n]*?(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:[i\u0130\u0131]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))[^\n]*?(?:[\x3a]|%(?:25%?)*3a|\\u?0*(?:72|3a))[^\n]*?((?:l|%(?:25%?)*(?:4c|6c)|\\u?0*(?:154|114|6c|4c))[^\n]*?(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:a|%(?:25%?)*(?:41|61)|\\u?0*(?:101|61|41|141))[^\n]*?(?:p|%(?:25%?)*(?:50|70)|\\u?0*(?:70|50|160|120))(?:[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163)))?|(?:r|%(?:25%?)*(?:52|72)|\\u?0*(?:122|72|52|162))[^\n]*?(?:m|%(?:25%?)*(?:4d|6d)|\\u?0*(?:4d|155|115|6d))[^\n]*?(?:[i\u0130\u0131]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))|(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))|(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:[i\u0130\u0131]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))|(?:[^\n]*?(?:[i\u0130\u0131]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))){2}[^\n]*?(?:o|%(?:25%?)*(?:4f|6f)|\\u?0*(?:6f|4f|157|117))[^\n]*?(?:p|%(?:25%?)*(?:50|70)|\\u?0*(?:70|50|160|120))|(?:c|%(?:25%?)*(?:43|63)|\\u?0*(?:143|103|63|43))[^\n]*?(?:o|%(?:25%?)*(?:4f|6f)|\\u?0*(?:6f|4f|157|117))[^\n]*?(?:r|%(?:25%?)*(?:52|72)|\\u?0*(?:122|72|52|162))[^\n]*?(?:b|%(?:25%?)*(?:42|62)|\\u?0*(?:102|62|42|142))[^\n]*?(?:a|%(?:25%?)*(?:41|61)|\\u?0*(?:101|61|41|141))|(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))|(?:h|%(?:25%?)*(?:48|68)|\\u?0*(?:110|68|48|150))(?:[^\n]*?(?:t|%(?:25%?)*(?:54|74)|\\u?0*(?:124|74|54|164))){2}[^\n]*?(?:p|%(?:25%?)*(?:50|70)|\\u?0*(?:70|50|160|120))(?:[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163)))?)[^\n]*?(?:[\x3a]|%(?:25%?)*3a|\\u?0*(?:72|3a))|(?:b|%(?:25%?)*(?:42|62)|\\u?0*(?:102|62|42|142))[^\n]*?(?:a|%(?:25%?)*(?:41|61)|\\u?0*(?:101|61|41|141))[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))[^\n]*?(?:e|%(?:25%?)*(?:45|65)|\\u?0*(?:45|145|105|65))[^\n]*?(?:[\x3a]|%(?:25%?)*3a|\\u?0*(?:72|3a))(JH[s-v]|[\x2b\x2f-9A-Za-z][CSiy]R7|[\x2b\x2f-9A-Za-z]{2}[048AEIMQUYcgkosw]ke[\x2b\x2f-9w-z]))')


def detect_jndi(text, context=""):
    if not isinstance(text, str):
        return

    match = JNDI_PATTERN.search(text)
    if match:
        client_ip = get_real_client_ip(dict(request.headers), request.remote_addr)

        logger.warning(
            f"[CVE-2021-44228 EXPLOIT DETECTED] Client: {client_ip} | Context: {context}"
        )

        payload_info = f"Context: {context}\nFull Payload: {text}\nMatched Pattern: {match.group(0)}"
        if match.groups():
            payload_info += f"\nCaptured Groups: {match.groups()}"

        extracted_payloads = [match.group(0)]
        if match.groups():
            extracted_payloads.extend([g for g in match.groups() if g])

        body = request.get_data()
        if not body:
            # If no body, use the payload info as body
            body = payload_info.encode('utf-8')

        query_string = request.query_string.decode('utf-8') if request.query_string else None

        sample_path = save_exploit_sample(
            cve="CVE-2021-44228",
            client_ip=client_ip,
            headers=dict(request.headers),
            body=body,
            samples_dir=SAMPLES_DIR,
            honeypot="solr-log4shell",
            method=request.method,
            path=request.path,
            query_string=query_string,
            protocol=request.environ.get('SERVER_PROTOCOL', 'HTTP/1.1'),
            extracted_payloads=extracted_payloads,
            attack_type="log4shell_jndi",
            confidence="high",
            context=context
        )

        logger.info(f"Attack payload saved to {sample_path}")


@app.before_request
def check_all_inputs():
    # Log request with real client IP
    client_ip = get_real_client_ip(dict(request.headers), request.remote_addr)
    logger.info(f"Request from {client_ip}: {request.method} {request.path}")

    for header, value in request.headers:
        detect_jndi(value, context=f"header:{header}")

    for param, value in request.args.items():
        if isinstance(value, str):
            detect_jndi(value, context=f"query_param:{param}")

    if request.form:
        for param, value in request.form.items():
            if isinstance(value, str):
                detect_jndi(value, context=f"form_param:{param}")

    if request.is_json:
        try:
            json_data = request.get_json()
            detect_jndi(json.dumps(json_data), context="json_body")
        except:
            pass

    if request.data:
        try:
            body_str = request.data.decode('utf-8', errors='ignore')
            detect_jndi(body_str, context="raw_body")
        except:
            pass

    detect_jndi(request.path, context="url_path")


@app.after_request
def add_solr_headers(response):
    response.headers['Server'] = f'Apache/{APACHE_VERSION} (Unix)'
    response.headers['X-Frame-Options'] = 'SAMEORIGIN'
    response.headers['X-Content-Type-Options'] = 'nosniff'
    return response


@app.route('/')
@app.route('/solr')
@app.route('/solr/')
def admin_dashboard():
    return render_template('admin.html',
                         solr_version=SOLR_VERSION,
                         collection_name=COLLECTION_NAME)


@app.route('/solr/<collection>/select', methods=['GET', 'POST'])
def collection_select(collection):
    q = request.args.get('q', '*:*')
    wt = request.args.get('wt', 'json')
    rows = request.args.get('rows', '10')

    response_data = {
        "responseHeader": {
            "status": 0,
            "QTime": 3,
            "params": {
                "q": q,
                "wt": wt,
                "rows": rows
            }
        },
        "response": {
            "numFound": 42,
            "start": 0,
            "docs": [
                {
                    "id": "doc1",
                    "title": "Sample Document 1",
                    "content": "This is a sample search result from our Solr instance."
                },
                {
                    "id": "doc2",
                    "title": "Sample Document 2",
                    "content": "Another sample document for realistic search results."
                }
            ]
        }
    }

    return jsonify(response_data)


@app.route('/solr/admin/ping', methods=['GET'])
def admin_ping():
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 1
        },
        "status": "OK"
    })


@app.route('/solr/admin/info/system', methods=['GET'])
def admin_system_info():
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 2
        },
        "mode": "std",
        "solr_home": "/var/solr/data",
        "lucene": {
            "solr-spec-version": SOLR_VERSION,
            "solr-impl-version": f"{SOLR_VERSION} - built 2021-12-14",
            "lucene-spec-version": "8.11.0",
            "lucene-impl-version": "8.11.0"
        },
        "jvm": {
            "version": "11.0.13 64-Bit Server VM - Oracle Corporation",
            "name": "Java HotSpot(TM) 64-Bit Server VM",
            "spec": {
                "vendor": "Oracle Corporation",
                "name": "Java Platform API Specification",
                "version": "11"
            },
            "processors": 4,
            "memory": {
                "free": "245.8 MB",
                "total": "512 MB",
                "max": "512 MB",
                "used": "266.2 MB"
            }
        },
        "system": {
            "name": "Linux",
            "arch": "amd64",
            "version": "5.10.0",
            "availableProcessors": 4,
            "systemLoadAverage": 0.85
        }
    })


@app.route('/solr/<collection>/schema', methods=['GET'])
def collection_schema(collection):
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 1
        },
        "schema": {
            "name": "default-config",
            "version": 1.6,
            "uniqueKey": "id",
            "fieldTypes": [
                {"name": "string", "class": "solr.StrField"},
                {"name": "text_general", "class": "solr.TextField"}
            ],
            "fields": [
                {"name": "id", "type": "string", "indexed": True, "stored": True, "required": True},
                {"name": "title", "type": "text_general", "indexed": True, "stored": True},
                {"name": "content", "type": "text_general", "indexed": True, "stored": True}
            ]
        }
    })


@app.route('/solr/admin/collections', methods=['GET'])
def admin_collections():
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 5
        },
        "collections": [COLLECTION_NAME]
    })


@app.route('/solr/<collection>/update', methods=['POST'])
def collection_update(collection):
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 12
        }
    })


@app.route('/favicon.ico')
def favicon():
    # This is where my favicon would go. IF I HAD ONE
    from base64 import b64decode
    gif_data = b64decode('R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')
    from flask import Response
    return Response(gif_data, mimetype='image/gif')


@app.route('/robots.txt')
def robots():
    return """User-agent: *
Disallow: /solr/admin/
Disallow: /solr/*/update
Allow: /solr/

# Crawl-delay for polite bots
Crawl-delay: 10
""", 200, {'Content-Type': 'text/plain'}


@app.route('/sitemap.xml')
def sitemap():
    base_url = request.host_url.rstrip('/')
    sitemap_xml = f"""<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url>
    <loc>{base_url}/</loc>
    <lastmod>2025-11-06</lastmod>
    <changefreq>daily</changefreq>
    <priority>1.0</priority>
  </url>
  <url>
    <loc>{base_url}/solr/</loc>
    <lastmod>2025-11-06</lastmod>
    <changefreq>daily</changefreq>
    <priority>0.8</priority>
  </url>
  <url>
    <loc>{base_url}/solr/admin/ping</loc>
    <lastmod>2025-11-06</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.5</priority>
  </url>
  <url>
    <loc>{base_url}/solr/admin/info/system</loc>
    <lastmod>2025-11-06</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.5</priority>
  </url>
  <url>
    <loc>{base_url}/solr/{COLLECTION_NAME}/select?q=*:*</loc>
    <lastmod>2025-11-06</lastmod>
    <changefreq>hourly</changefreq>
    <priority>0.7</priority>
  </url>
  <url>
    <loc>{base_url}/solr/{COLLECTION_NAME}/schema</loc>
    <lastmod>2025-11-06</lastmod>
    <changefreq>monthly</changefreq>
    <priority>0.6</priority>
  </url>
</urlset>"""
    return sitemap_xml, 200, {'Content-Type': 'application/xml'}


@app.route('/solr/admin/cores', methods=['GET'])
def admin_cores():
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 3
        },
        "status": {
            COLLECTION_NAME: {
                "name": COLLECTION_NAME,
                "instanceDir": f"/var/solr/data/{COLLECTION_NAME}",
                "dataDir": f"/var/solr/data/{COLLECTION_NAME}/data/",
                "config": "solrconfig.xml",
                "schema": "managed-schema",
                "startTime": "2025-11-06T00:00:00.000Z",
                "uptime": 86400000
            }
        }
    })


@app.errorhandler(404)
def not_found(e):
    return jsonify({
        "responseHeader": {
            "status": 404,
            "QTime": 1
        },
        "error": {
            "msg": "Not Found",
            "code": 404
        }
    }), 404


@app.errorhandler(500)
def internal_error(e):
    return jsonify({
        "responseHeader": {
            "status": 500,
            "QTime": 1
        },
        "error": {
            "msg": "Internal Server Error",
            "code": 500
        }
    }), 500


if __name__ == '__main__':
    logger.info(f"Starting CVE-2021-44228 Apache Solr Honeypot on {LISTEN_HOST}:{LISTEN_PORT}")
    logger.info(f"-> Solr Version: {SOLR_VERSION}")
    logger.info(f"-> Apache Version: {APACHE_VERSION}")
    logger.info(f"-> Collection: {COLLECTION_NAME}")
    logger.info(f"-> Samples directory: {SAMPLES_DIR}")
    app.run(host=LISTEN_HOST, port=LISTEN_PORT, debug=False)
