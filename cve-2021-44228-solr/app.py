import re
import logging
import os
import json
from datetime import datetime
from pathlib import Path
from flask import Flask, request, jsonify, render_template_string, send_from_directory

logging.basicConfig(
    level=logging.INFO,
    format='[%(asctime)s] [%(levelname)s] %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger(__name__)

app = Flask(__name__)

SAMPLES_DIR = Path('/samples')
SAMPLES_DIR.mkdir(exist_ok=True)

LISTEN_HOST = os.getenv('LISTEN_HOST', '0.0.0.0')
LISTEN_PORT = int(os.getenv('LISTEN_PORT', '8000'))
SOLR_VERSION = os.getenv('SOLR_VERSION', '8.11.0')
APACHE_VERSION = os.getenv('APACHE_VERSION', '2.4.41')
COLLECTION_NAME = os.getenv('COLLECTION_NAME', 'collection1')

# from https://github.com/back2root/log4shell-rex
JNDI_PATTERN = re.compile(r'(?im)(?:^|[\n]).*?(?:[\x24]|%(?:25%?)*24|\\u?0*(?:44|24))(?:[\x7b]|%(?:25%?)*7b|\\u?0*(?:7b|173))[^\n]*?((?:j|%(?:25%?)*(?:4a|6a)|\\u?0*(?:112|6a|4a|152))[^\n]*?(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:[i\u0130\u0131]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))[^\n]*?(?:[\x3a]|%(?:25%?)*3a|\\u?0*(?:72|3a))[^\n]*?((?:l|%(?:25%?)*(?:4c|6c)|\\u?0*(?:154|114|6c|4c))[^\n]*?(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:a|%(?:25%?)*(?:41|61)|\\u?0*(?:101|61|41|141))[^\n]*?(?:p|%(?:25%?)*(?:50|70)|\\u?0*(?:70|50|160|120))(?:[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163)))?|(?:r|%(?:25%?)*(?:52|72)|\\u?0*(?:122|72|52|162))[^\n]*?(?:m|%(?:25%?)*(?:4d|6d)|\\u?0*(?:4d|155|115|6d))[^\n]*?(?:[i\u0130\u0131]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))|(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))|(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:[i\u0130\u0131]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))|(?:[^\n]*?(?:[i\u0130\u0131]|%(?:25%?)*(?:49|69|C4%(?:25%?)*B0|C4%(?:25%?)*B1)|\\u?0*(?:111|69|49|151|130|460|131|461))){2}[^\n]*?(?:o|%(?:25%?)*(?:4f|6f)|\\u?0*(?:6f|4f|157|117))[^\n]*?(?:p|%(?:25%?)*(?:50|70)|\\u?0*(?:70|50|160|120))|(?:c|%(?:25%?)*(?:43|63)|\\u?0*(?:143|103|63|43))[^\n]*?(?:o|%(?:25%?)*(?:4f|6f)|\\u?0*(?:6f|4f|157|117))[^\n]*?(?:r|%(?:25%?)*(?:52|72)|\\u?0*(?:122|72|52|162))[^\n]*?(?:b|%(?:25%?)*(?:42|62)|\\u?0*(?:102|62|42|142))[^\n]*?(?:a|%(?:25%?)*(?:41|61)|\\u?0*(?:101|61|41|141))|(?:n|%(?:25%?)*(?:4e|6e)|\\u?0*(?:4e|156|116|6e))[^\n]*?(?:d|%(?:25%?)*(?:44|64)|\\u?0*(?:44|144|104|64))[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))|(?:h|%(?:25%?)*(?:48|68)|\\u?0*(?:110|68|48|150))(?:[^\n]*?(?:t|%(?:25%?)*(?:54|74)|\\u?0*(?:124|74|54|164))){2}[^\n]*?(?:p|%(?:25%?)*(?:50|70)|\\u?0*(?:70|50|160|120))(?:[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163)))?)[^\n]*?(?:[\x3a]|%(?:25%?)*3a|\\u?0*(?:72|3a))|(?:b|%(?:25%?)*(?:42|62)|\\u?0*(?:102|62|42|142))[^\n]*?(?:a|%(?:25%?)*(?:41|61)|\\u?0*(?:101|61|41|141))[^\n]*?(?:[s\u017f]|%(?:25%?)*(?:53|73|C5%(?:25%?)*BF)|\\u?0*(?:17f|123|577|73|53|163))[^\n]*?(?:e|%(?:25%?)*(?:45|65)|\\u?0*(?:45|145|105|65))[^\n]*?(?:[\x3a]|%(?:25%?)*3a|\\u?0*(?:72|3a))(JH[s-v]|[\x2b\x2f-9A-Za-z][CSiy]R7|[\x2b\x2f-9A-Za-z]{2}[048AEIMQUYcgkosw]ke[\x2b\x2f-9w-z]))')


def detect_jndi(text, context=""):
    if not isinstance(text, str):
        return

    match = JNDI_PATTERN.search(text)
    if match:
        timestamp = datetime.now().isoformat()
        client_ip = request.remote_addr

        logger.warning(
            f"[CVE-2021-44228 EXPLOIT DETECTED] Client: {client_ip} | Context: {context}"
        )

        filename = f"log4shell-webapp_{timestamp.replace(':', '-')}_{client_ip}.txt"
        sample_path = SAMPLES_DIR / filename

        with open(sample_path, 'w') as f:
            f.write(f"Timestamp: {timestamp}\n")
            f.write(f"Client IP: {client_ip}\n")
            f.write(f"Context: {context}\n")
            f.write(f"Request Method: {request.method}\n")
            f.write(f"Request Path: {request.path}\n")
            f.write(f"User-Agent: {request.headers.get('User-Agent', 'N/A')}\n")
            f.write(f"Full Payload: {text}\n")
            f.write(f"Matched Pattern: {match.group(0)}\n")
            if match.groups():
                f.write(f"Captured Groups: {match.groups()}\n")
            f.write(f"\nAll Headers:\n")
            for header, value in request.headers:
                f.write(f"  {header}: {value}\n")

        logger.info(f"Attack payload saved to {sample_path}")


@app.before_request
def check_all_inputs():
    for header, value in request.headers:
        detect_jndi(value, context=f"header:{header}")

    for param, value in request.args.items():
        if isinstance(value, str):
            detect_jndi(value, context=f"query_param:{param}")

    if request.form:
        for param, value in request.form.items():
            if isinstance(value, str):
                detect_jndi(value, context=f"form_param:{param}")

    if request.is_json:
        try:
            json_data = request.get_json()
            detect_jndi(json.dumps(json_data), context="json_body")
        except:
            pass

    if request.data:
        try:
            body_str = request.data.decode('utf-8', errors='ignore')
            detect_jndi(body_str, context="raw_body")
        except:
            pass

    detect_jndi(request.path, context="url_path")

    logger.info(f"Request from {request.remote_addr}: {request.method} {request.path}")


@app.after_request
def add_solr_headers(response):
    response.headers['Server'] = f'Apache/{APACHE_VERSION} (Unix)'
    response.headers['X-Frame-Options'] = 'SAMEORIGIN'
    response.headers['X-Content-Type-Options'] = 'nosniff'
    return response


SOLR_ADMIN_HTML = """
<!DOCTYPE html>
<html>
<head>
    <title>Solr Admin</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .header { background: #fff; padding: 15px; border-bottom: 3px solid #e74c3c; }
        .header h1 { margin: 0; color: #333; }
        .version { color: #666; font-size: 14px; }
        .content { background: #fff; margin-top: 20px; padding: 20px; }
        .section { margin: 20px 0; }
        .section h2 { color: #e74c3c; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .info-item { padding: 8px 0; border-bottom: 1px solid #eee; }
        .info-label { font-weight: bold; color: #555; display: inline-block; width: 200px; }
        .info-value { color: #333; }
        a { color: #e74c3c; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .status-ok { color: #27ae60; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Apache Solr Admin</h1>
        <div class="version">Solr Specification Version: """ + SOLR_VERSION + """</div>
    </div>
    <div class="content">
        <div class="section">
            <h2>Dashboard</h2>
            <div class="info-item">
                <span class="info-label">Solr Version:</span>
                <span class="info-value">""" + SOLR_VERSION + """</span>
            </div>
            <div class="info-item">
                <span class="info-label">Status:</span>
                <span class="info-value status-ok">Running</span>
            </div>
            <div class="info-item">
                <span class="info-label">Default Collection:</span>
                <span class="info-value">""" + COLLECTION_NAME + """</span>
            </div>
        </div>
        <div class="section">
            <h2>Quick Links</h2>
            <div class="info-item">
                <a href="/solr/""" + COLLECTION_NAME + """/select?q=*:*">Query Collection</a>
            </div>
            <div class="info-item">
                <a href="/solr/admin/info/system">System Information</a>
            </div>
            <div class="info-item">
                <a href="/solr/admin/ping">Health Check</a>
            </div>
            <div class="info-item">
                <a href="/solr/""" + COLLECTION_NAME + """/schema">Schema Browser</a>
            </div>
        </div>
    </div>
</body>
</html>
"""


@app.route('/')
@app.route('/solr')
@app.route('/solr/')
def admin_dashboard():
    return render_template_string(SOLR_ADMIN_HTML)


@app.route('/solr/<collection>/select', methods=['GET', 'POST'])
def collection_select(collection):
    q = request.args.get('q', '*:*')
    wt = request.args.get('wt', 'json')
    rows = request.args.get('rows', '10')

    response_data = {
        "responseHeader": {
            "status": 0,
            "QTime": 3,
            "params": {
                "q": q,
                "wt": wt,
                "rows": rows
            }
        },
        "response": {
            "numFound": 42,
            "start": 0,
            "docs": [
                {
                    "id": "doc1",
                    "title": "Sample Document 1",
                    "content": "This is a sample search result from our Solr instance."
                },
                {
                    "id": "doc2",
                    "title": "Sample Document 2",
                    "content": "Another sample document for realistic search results."
                }
            ]
        }
    }

    return jsonify(response_data)


@app.route('/solr/admin/ping', methods=['GET'])
def admin_ping():
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 1
        },
        "status": "OK"
    })


@app.route('/solr/admin/info/system', methods=['GET'])
def admin_system_info():
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 2
        },
        "mode": "std",
        "solr_home": "/var/solr/data",
        "lucene": {
            "solr-spec-version": SOLR_VERSION,
            "solr-impl-version": f"{SOLR_VERSION} - built 2021-12-14",
            "lucene-spec-version": "8.11.0",
            "lucene-impl-version": "8.11.0"
        },
        "jvm": {
            "version": "11.0.13 64-Bit Server VM - Oracle Corporation",
            "name": "Java HotSpot(TM) 64-Bit Server VM",
            "spec": {
                "vendor": "Oracle Corporation",
                "name": "Java Platform API Specification",
                "version": "11"
            },
            "processors": 4,
            "memory": {
                "free": "245.8 MB",
                "total": "512 MB",
                "max": "512 MB",
                "used": "266.2 MB"
            }
        },
        "system": {
            "name": "Linux",
            "arch": "amd64",
            "version": "5.10.0",
            "availableProcessors": 4,
            "systemLoadAverage": 0.85
        }
    })


@app.route('/solr/<collection>/schema', methods=['GET'])
def collection_schema(collection):
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 1
        },
        "schema": {
            "name": "default-config",
            "version": 1.6,
            "uniqueKey": "id",
            "fieldTypes": [
                {"name": "string", "class": "solr.StrField"},
                {"name": "text_general", "class": "solr.TextField"}
            ],
            "fields": [
                {"name": "id", "type": "string", "indexed": True, "stored": True, "required": True},
                {"name": "title", "type": "text_general", "indexed": True, "stored": True},
                {"name": "content", "type": "text_general", "indexed": True, "stored": True}
            ]
        }
    })


@app.route('/solr/admin/collections', methods=['GET'])
def admin_collections():
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 5
        },
        "collections": [COLLECTION_NAME]
    })


@app.route('/solr/<collection>/update', methods=['POST'])
def collection_update(collection):
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 12
        }
    })


@app.route('/favicon.ico')
def favicon():
    # This is where my favicon would go. IF I HAD ONE
    from base64 import b64decode
    gif_data = b64decode('R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')
    from flask import Response
    return Response(gif_data, mimetype='image/gif')


@app.route('/robots.txt')
def robots():
    return """User-agent: *
Disallow: /solr/admin/
Disallow: /solr/*/update
Allow: /solr/

# Crawl-delay for polite bots
Crawl-delay: 10
""", 200, {'Content-Type': 'text/plain'}


@app.route('/solr/admin/cores', methods=['GET'])
def admin_cores():
    return jsonify({
        "responseHeader": {
            "status": 0,
            "QTime": 3
        },
        "status": {
            COLLECTION_NAME: {
                "name": COLLECTION_NAME,
                "instanceDir": f"/var/solr/data/{COLLECTION_NAME}",
                "dataDir": f"/var/solr/data/{COLLECTION_NAME}/data/",
                "config": "solrconfig.xml",
                "schema": "managed-schema",
                "startTime": "2025-11-06T00:00:00.000Z",
                "uptime": 86400000
            }
        }
    })


@app.errorhandler(404)
def not_found(e):
    return jsonify({
        "responseHeader": {
            "status": 404,
            "QTime": 1
        },
        "error": {
            "msg": "Not Found",
            "code": 404
        }
    }), 404


@app.errorhandler(500)
def internal_error(e):
    return jsonify({
        "responseHeader": {
            "status": 500,
            "QTime": 1
        },
        "error": {
            "msg": "Internal Server Error",
            "code": 500
        }
    }), 500


if __name__ == '__main__':
    logger.info(f"Starting CVE-2021-44228 Apache Solr Honeypot on {LISTEN_HOST}:{LISTEN_PORT}")
    logger.info(f"-> Solr Version: {SOLR_VERSION}")
    logger.info(f"-> Apache Version: {APACHE_VERSION}")
    logger.info(f"-> Collection: {COLLECTION_NAME}")
    logger.info(f"-> Samples directory: {SAMPLES_DIR}")
    app.run(host=LISTEN_HOST, port=LISTEN_PORT, debug=False)
